parameters:
- name: 'TASK_NAME'
  default: 'TASK_NOT_FOUND'
  type: string
- name: 'GITHUB_AUTH'
  default: 'token'
  type: string
- name: 'GIT_COMMIT'
  default: 'sha1'
  type: string
- name: 'BUILDID'
  default: '0'
  type: string
- name: 'AUTH'
  default: '0'
  type: string

steps:
  steps:
- script: curl -X GET -H '${{ parameters.AUTH }}' "$( echo "https://dev.azure.com/thierrychantier/evaluation for build/_apis/build/builds/${{ parameters.BUILDID }}/timeline?api-version=5.1" | sed 's/ /%20/g' )" >> output.txt
- script: cat output.txt
- script: |
    $status = cat output.txt | jq -c '. .records[] | select(.name=="${{ parameters.TASK_NAME }}") | .result'
    Write-Host $status
  condition: succeededOrFailed()
- powershell: |
   $url = "https://api.github.com/repos/victor-gallet/pipelines-java/statuses/${{ parameters.GIT_COMMIT }}"
   $result = Invoke-RestMethod -Uri $url -Headers @{   
    Authorization = "token ${{ parameters.GITHUB_AUTH }}"
   } -Body (@{"state"="failure";"description"="${{ parameters.TASK_NAME }}";"context"="${{ parameters.TASK_NAME }}";}|ConvertTo-Json) -Method POST
  condition: failed()
  displayName: Github statuses ${{ parameters.TASK_NAME }} failed
- powershell: |
   $url = "https://api.github.com/repos/victor-gallet/pipelines-java/statuses/${{ parameters.GIT_COMMIT }}"
   $result = Invoke-RestMethod -Uri $url -Headers @{   
    Authorization = "token ${{ parameters.GITHUB_AUTH }}"
   } -Body (@{"state"="success";"description"="${{ parameters.TASK_NAME }}";"context"="${{ parameters.TASK_NAME }}";}|ConvertTo-Json) -Method POST
  condition: succeeded()
  displayName: Github statuses ${{ parameters.TASK_NAME }} succeeded